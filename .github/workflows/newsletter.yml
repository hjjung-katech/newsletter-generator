name: Newsletter Generator CI

on:
  push:
    branches:
      - main
    paths:
      - 'config.yml'
      - '.github/workflows/newsletter.yml'
      - 'newsletter/**/*.py'
      - 'requirements.txt'
  schedule:
    # í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë§¤ì¼ ì˜¤ì „ 8ì‹œì— ì‹¤í–‰ (UTC 23:00)
    # You can adjust the schedule as needed.
    - cron: '0 23 * * *'
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  generate_and_distribute_newsletter:
    runs-on: ubuntu-latest
    permissions:
      contents: write # For committing to gh-pages branch
      pages: write    # For deploying to GitHub Pages
      id-token: write # For OIDC token if used by an action

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        timeout-minutes: 15
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e . --no-deps

      - name: Set up environment variables and directories
        run: |
          # Create required directories
          mkdir -p output
          mkdir -p config
          
          # Set environment variables for gRPC issues
          echo "GRPC_DNS_RESOLVER=native" >> $GITHUB_ENV
          echo "GRPC_POLL_STRATEGY=epoll1" >> $GITHUB_ENV
          echo "GOOGLE_API_USE_REST=true" >> $GITHUB_ENV
          echo "GRPC_ENABLE_FORK_SUPPORT=0" >> $GITHUB_ENV
          echo "LANGCHAIN_TRACING_V2=false" >> $GITHUB_ENV
          
          # Create .env file for development
          echo "GEMINI_API_KEY=dummy_key_for_testing" > .env
          echo "SERPER_API_KEY=dummy_key_for_testing" >> .env

      - name: Validate configuration
        run: |
          if [ -f "config.yml" ]; then
            echo "âœ“ Configuration file exists"
            python -c "import yaml; yaml.safe_load(open('config.yml'))" && echo "âœ“ Configuration file is valid YAML"
          else
            echo "âš  Configuration file not found, will use defaults"
          fi

      - name: Generate Newsletter
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          # Check if we have real API keys
          if [ "$GEMINI_API_KEY" = "" ] || [ "$GEMINI_API_KEY" = "dummy_key_for_testing" ]; then
            echo "ğŸ”¶ Running in CI test mode with dummy content (no real API keys)"
            
            # Generate test newsletter
            cat > output/newsletter.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CI Test Newsletter</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; }
                  .header { background-color: #f0f0f0; padding: 20px; text-align: center; }
                  .content { margin: 20px 0; }
                  .footer { background-color: #f0f0f0; padding: 10px; text-align: center; font-size: 12px; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸš€ í…ŒìŠ¤íŠ¸ ë‰´ìŠ¤ë ˆí„°</h1>
                  <p>GitHub Actions CI/CD í…ŒìŠ¤íŠ¸ìš© ë‰´ìŠ¤ë ˆí„°</p>
              </div>
              
              <div class="content">
                  <h2>ğŸ“° ì£¼ìš” ë‰´ìŠ¤</h2>
                  <p>ì´ ë‰´ìŠ¤ë ˆí„°ëŠ” CI/CD íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                  
                  <h3>ğŸ”§ ê¸°ìˆ  ì—…ë°ì´íŠ¸</h3>
                  <ul>
                      <li>GitHub Actions ì›Œí¬í”Œë¡œìš° ê°œì„  ì™„ë£Œ</li>
                      <li>Python íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ìµœì í™”</li>
                      <li>í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í–¥ìƒ</li>
                  </ul>
                  
                  <h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3>
                  <p>âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼<br>
                     âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼<br>
                     âœ… ìë™ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ</p>
              </div>
              
              <div class="footer">
                  <p>Generated at: $(date)<br>
                     Build: ${{ github.run_number }}<br>
                     Commit: ${{ github.sha }}</p>
              </div>
          </body>
          </html>
          EOF
            
            echo "âœ… Generated test newsletter in output/newsletter.html"
          else
            echo "ğŸš€ Running with real API keys - generating actual newsletter"
            # Here would be the actual newsletter generation command
            # python -m newsletter.main --config config.yml
            echo "âš  Real newsletter generation not implemented yet"
            
            # For now, still generate test content
            cp output/newsletter.html output/newsletter_backup.html 2>/dev/null || true
          fi

      - name: Verify output
        run: |
          if [ -f "output/newsletter.html" ]; then
            echo "âœ… Newsletter file generated successfully"
            echo "File size: $(wc -c < output/newsletter.html) bytes"
            echo "First few lines:"
            head -10 output/newsletter.html
          else
            echo "âŒ Newsletter file not found!"
            exit 1
          fi

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload newsletter to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './output/'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
